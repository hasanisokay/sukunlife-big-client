import { Geist, Geist_Mono, Montserrat } from "next/font/google";
import "./globals.css";
import Navbar from "@/components/nav/Navbar";
import StoreProvider from "@/components/providers/StoreProvider";
import getThemeCookie from "@/utils/getThemeCookie.mjs";
import { makeStore } from "@/store/store";
import { setEnrolledCourses, setUserData } from "@/store/slices/authSlice";
import { setTheme } from "@/store/slices/themeSlice";
import ThemeProvider from "@/components/providers/ThemeProvider";
import checkToken from "@/utils/checkToken.mjs";
import TokenRefreh from "@/components/providers/TokenRefreh";
import getUserDataFromToken from "@/utils/getUserDataFromToken.mjs";
import getCartItemsFromDb from "@/components/cart/functions/getCartItemsFromDb.mjs";
import { setCartData } from "@/store/slices/cartSlice";
import getEnrolledCourses from "@/utils/getEnrolledCourses.mjs";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});
const montserrat = Montserrat({
  variable: "--font-montserrat",
  subsets: ["latin"],
});

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default async function RootLayout({ children }) {
  const refreshToken = await checkToken();
  let storedTheme = await getThemeCookie();
  let userData = await getUserDataFromToken();
  const store = makeStore();
  store.dispatch(setUserData(userData || null));
  store.dispatch(setTheme(storedTheme));
  if (userData) {
    const cartItems = await getCartItemsFromDb(userData?._id);
    store.dispatch(setCartData(cartItems?.cart?.cart));
    const courses = await getEnrolledCourses(userData._id);
    store.dispatch(setEnrolledCourses(courses?.courses?.enrolledCourses));
  }
  const initialReduxState = store.getState();
  return (
    <html lang="en" data-theme={storedTheme}>
      {/* className={`light ${storedTheme ==="dark"? "dark":""}`} */}
      <StoreProvider initialReduxState={initialReduxState}>
        <TokenRefreh refreshToken={refreshToken}>
          <ThemeProvider>
            <body
              className={`${geistSans.variable} ${geistMono.variable} ${montserrat.variable} antialiased`}
            >
              <Navbar />
              {children}
            </body>
          </ThemeProvider>
        </TokenRefreh>
      </StoreProvider>
    </html>
  );
}
